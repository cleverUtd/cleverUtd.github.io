<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Keep it simple,stupid"><title>Shiro与Spring集成实现权限管理 | Coding</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Shiro与Spring集成实现权限管理</h1><a id="logo" href="/.">Coding</a><p class="description">Keep Calm And Coding</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/booklist/"><i class="fa fa-user"> booklist</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Shiro与Spring集成实现权限管理</h1><div class="post-meta">Feb 16, 2016<span> | </span><span class="category"><a href="/categories/webdev/">Web开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/02/16/Shiro与Spring集成实现权限管理/" href="/2016/02/16/Shiro与Spring集成实现权限管理/#comments" class="ds-thread-count"></a><div class="post-content"><h1 id="shiro核心概念">shiro核心概念</h1><h2 id="Subject">Subject</h2><pre><code>大多数情况下,可以简单理解成<span class="string">"当前用户"</span>的概念,在代码任何地方都可以获取,获取后能够进行登录,登出,授权检查等操作
</code></pre><h2 id="SecurityManager">SecurityManager</h2><pre><code>Subject代表了当前用户的安全操作,SecurityManager管理所有用户的安全操作。它是Shiro框架的核心
</code></pre><h2 id="Realms">Realms</h2><pre><code>相当于数据源。配置Shiro时，必须至少指定一个Realm。执行认证和授权时，shiro会从realms获取认证数据
</code></pre><p>关于shiro的教程这里就不详述了，可参考：</p>
<p><a href="https://waylau.gitbooks.io/apache-shiro-1-2-x-reference/content/index.html" target="_blank" rel="external">apache-shiro-1.2.x-reference</a></p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/2049092" target="_blank" rel="external">跟我学Shiro</a></p>
<p><a href="http://www.infoq.com/cn/articles/apache-shiro" target="_blank" rel="external">让Apache Shiro保护你的应用</a></p>
<a id="more"></a>
<h1 id="maven配置依赖">maven配置依赖</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;shiro.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shiro-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;shiro.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- 如果要与spring集成，需要添加此依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;shiro.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>${shiro.version}请自行替换成当前的最新版本</p>
<h1 id="整合spring">整合spring</h1><h2 id="web-xml">web.xml</h2><p>增加filter和filter-mapping</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">&lt;filter&gt;</span></span><br><span class="line">    <span class="variable">&lt;filter-name&gt;</span>shiroFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">    <span class="variable">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="variable">&lt;/filter-class&gt;</span></span><br><span class="line">    <span class="variable">&lt;init-param&gt;</span></span><br><span class="line">        <span class="variable">&lt;param-name&gt;</span>targetFilterLifecycle<span class="variable">&lt;/param-name&gt;</span></span><br><span class="line">        <span class="variable">&lt;param-value&gt;</span>true<span class="variable">&lt;/param-value&gt;</span></span><br><span class="line">    <span class="variable">&lt;/init-param&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">    <span class="variable">&lt;filter-name&gt;</span>shiroFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">    <span class="variable">&lt;url-pattern&gt;</span>/<span class="keyword">*</span><span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br></pre></td></tr></table></figure>
<p>filter-name对应spring配置中定义的名字为“shiroFilter”的bean</p>
<h2 id="spring配置">spring配置</h2><p>新建spring-shiro.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attribute">xmlns:util</span>=<span class="value">"http://www.springframework.org/schema/util"</span></span><br><span class="line">       <span class="attribute">xsi:schemaLocation</span>=<span class="value">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!-- 定义Realm --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"myRealm"</span> <span class="attribute">class</span>=<span class="value">"com.uniweibov2.shiro.realm.MyRealm"</span> /&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 自定义filter --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"roles"</span> <span class="attribute">class</span>=<span class="value">"com.uniweibov2.shiro.filter.MyRoleFilter"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"perms"</span> <span class="attribute">class</span>=<span class="value">"com.uniweibov2.shiro.filter.MyURLPermissionFilter"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"securityManager"</span> <span class="attribute">class</span>=<span class="value">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"realm"</span> <span class="attribute">ref</span>=<span class="value">"myRealm"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"shiroFilter"</span> <span class="attribute">class</span>=<span class="value">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"securityManager"</span> <span class="attribute">ref</span>=<span class="value">"securityManager"</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"loginUrl"</span> <span class="attribute">value</span>=<span class="value">"/user/login"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"unauthorizedUrl"</span> <span class="attribute">value</span>=<span class="value">"/unauth"</span>  /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"filters"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">map</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"roles"</span> <span class="attribute">value-ref</span>=<span class="value">"roles"</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"perms"</span> <span class="attribute">value-ref</span>=<span class="value">"perms"</span> /&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="title">map</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 过滤链定义 --&gt;</span>  </span><br><span class="line">              <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"filterChainDefinitions"</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="title">value</span>&gt;</span></span><br><span class="line">                            /user/login = anon <span class="comment">&lt;!--anon:anonymous, 匿名的, 不需要权限 --&gt;</span></span><br><span class="line">                            /user/logout = logout</span><br><span class="line">                            /my/customer/** = roles["user"]   <span class="comment">&lt;!-- 需要名称为user的角色权限--&gt;</span></span><br><span class="line">                           /customer/**=perms </span><br><span class="line">                     <span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!-- Shiro生命周期处理器 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"lifecycleBeanPostProcessor"</span> <span class="attribute">class</span>=<span class="value">"org.apache.shiro.spring.LifecycleBeanPostProcessor"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>filters属性用于自定义过滤器</p>
<p>filterChainDefinitions用于声明url和filter的关系，即哪些URL需要经过哪些filter进行鉴权</p>
<p>shiro也有很多默认的filter，上面的anon和logout使用的就是shiro默认filter。默认的roles和perms filter不满足要求，所以这里使用自定义的实现</p>
<p>配置好spring-shiro.xml，在spring.xml里import即可。</p>
<h1 id="自定义Realm">自定义Realm</h1><p>新建MyRealm：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AuthorizingRealm</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserRoleService</span> userRoleService;</span><br><span class="line">    <span class="annotation">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RoleResourcesService</span> roleResourcesService;</span><br><span class="line">    <span class="annotation">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ShiroRedis</span> shiroRedis;</span><br><span class="line"></span><br><span class="line">    <span class="type">Logger</span> log = <span class="type">LoggerFactory</span>.getLogger(<span class="type">MyRealm</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span><br><span class="line">     * 获取授权信息</span><br><span class="line">     * 每当需要鉴权时，都会先通过此方法获取用户拥有的权限，并包装成shiro自己封装的AuthorizationInfo对象里面</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">AuthorizationInfo</span> getAuthorizationInfo(<span class="type">PrincipalCollection</span> principals) &#123;</span><br><span class="line">        <span class="keyword">if</span> (principals == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">AuthorizationInfo</span> info = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">"Retrieving AuthorizationInfo for principals ["</span> + principals + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            info = shiroRedis.getAuthinfo(principals.toString());</span><br><span class="line">            <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">                info = <span class="keyword">this</span>.doGetAuthorizationInfo(principals);</span><br><span class="line">                <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                        log.trace(<span class="string">"Caching authorization info for principals: ["</span> + principals + <span class="string">"]."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    shiroRedis.putAuthinfo(principals.toString(), <span class="type">JsonUtil</span>.obj2JsonStr(info));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 获取授权信息，在这个方法中，从db获取当前登录用户的角色和资源权限信息</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">AuthorizationInfo</span> doGetAuthorizationInfo(<span class="type">PrincipalCollection</span> principalCollection) &#123;</span><br><span class="line">        int userId = <span class="type">Integer</span>.parseInt((<span class="type">String</span>) getAvailablePrincipal(principalCollection));</span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">UserRoles</span>&gt; userRoles = userRoleService.getRoleByUserId(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过用户名从数据库获取权限字符串</span></span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> info = <span class="keyword">new</span> <span class="type">SimpleAuthorizationInfo</span>();</span><br><span class="line">        <span class="comment">//角色权限</span></span><br><span class="line">        <span class="type">Set</span>&lt;<span class="type">String</span>&gt; roleSet = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//资源权限</span></span><br><span class="line">        <span class="type">Set</span>&lt;<span class="type">String</span>&gt; resourcesSet = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">UserRoles</span> userRole : userRoles) &#123;</span><br><span class="line">            roleSet.add(userRole.getRoleName());</span><br><span class="line">            <span class="type">List</span>&lt;<span class="type">RoleResources</span>&gt; resourceList = roleResourcesService.getResourcesByRole(userRole.getRoleId());</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">RoleResources</span> roleResources : resourceList) &#123;</span><br><span class="line">                resourcesSet.add(roleResources.getUri() + <span class="string">":"</span> + roleResources.getMethod());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        info.setRoles(roleSet);</span><br><span class="line">        info.setStringPermissions(resourcesSet);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 身份认证</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">AuthenticationInfo</span> doGetAuthenticationInfo(<span class="type">AuthenticationToken</span> token) <span class="keyword">throws</span> <span class="type">AuthenticationException</span> &#123;</span><br><span class="line">        <span class="type">String</span> userId = (<span class="type">String</span>) token.getPrincipal();</span><br><span class="line">        <span class="type">String</span> password = <span class="keyword">new</span> <span class="type">String</span>((char[]) token.getCredentials());</span><br><span class="line">        <span class="type">AuthenticationInfo</span> aInfo = <span class="keyword">new</span> <span class="type">SimpleAuthenticationInfo</span>(userId, password, getName());</span><br><span class="line">        <span class="keyword">return</span> aInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>AuthorizingRealm是Shiro负责身份认证的抽象类。需要实现doGetAuthenticationInfo和doGetAuthorizationInfo方法。</p>
<p>一般来说在doGetAuthenticationInfo方法里,实现的是对用户提交过来的用户名/密码 等账号信息,跟数据库进行交互判定登陆是否成功的过程。但是因为我们的系统之前已经有自己的一套认证逻辑，所以在这个方法里就不进行匹配，只是简单的包装成AuthenticationInfo对象并返回。<br>而在原来的登录认证代码中(UserController的login方法)，在匹配成功后，添加以下代码<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line">UsernamePasswordToken <span class="keyword">token</span> = new UsernamePasswordToken(user.getUserId().<span class="keyword">toString</span>(), user.getPasswd());</span><br><span class="line"><span class="comment">//此方法会进入MyRealm的doGetAuthenticationInfo()方法</span></span><br><span class="line">subject.login(<span class="keyword">token</span>);</span><br></pre></td></tr></table></figure></p>
<p>getAuthorizationInfo重写父类方法，此方法中，先通过redis查找用户的认证信息，如果没有调用doGetAuthorizationInfo方法从db中获取。<br>因为shiro默认的缓存只提供ecache实现，所以需要重写getAuthorizationInfo，自定义redis的缓存实现</p>
<p>doGetAuthorizationInfo 的中资源权限我使用URI:method(“/user/create:post”) 形式作为权限字符串</p>
<h1 id="权限校验">权限校验</h1><h2 id="数据库设计">数据库设计</h2><p>角色表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`roles`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'角色id'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'角色名称'</span>,</span><br><span class="line">  <span class="string">`detail`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'角色附加描述'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="string">`is_deleted`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'删除标识,0.可用，1.已删除不可用'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`u_key_name`</span> (<span class="string">`name`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'角色表'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>用户角色映射<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_roles`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'用户uid, 对应表users(u_id)'</span>,</span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'角色id, 对应表roles(ro_id)'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="string">`is_deleted`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'删除标识,0.可用，1.已删除不可用'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`u_key_u_id_ro_id`</span> (<span class="string">`user_id`</span>,<span class="string">`role_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`u_key_ro_id`</span> (<span class="string">`role_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'用户角色表'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>资源表(记录系统使用到的URL)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`resources`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">  <span class="string">`uri`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'请求相对路径'</span>,</span><br><span class="line">  <span class="string">`method`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span><span class="string">'请求方法 GET/POST'</span>,</span><br><span class="line">  <span class="string">`detail`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'uri详细描述'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="string">`is_deleted`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'删除标识,0.可用，1.已删除不可用'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`u_key_uri_method`</span> (<span class="string">`uri`</span>,<span class="string">`method`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'请求相对路径记录表'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>角色-资源权限映射表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`role_resources`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">  <span class="string">`resource_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'请求相对路径id'</span>,</span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'角色id'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="string">`is_deleted`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'删除标识,0.可用，1.已删除不可用'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`u_key_role_resource`</span> (<span class="string">`role_id`</span>,<span class="string">`resource_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'角色-资源权限映射表'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>user和role是多对多关系，角色和资源也是多对多关系</p>
<h2 id="角色校验">角色校验</h2><p>自定义RolesAuthorizationFilter<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyRoleFilter</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">RolesAuthorizationFilter</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> log = <span class="type">LoggerFactory</span>.getLogger(<span class="type">MyRoleFilter</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> boolean onAccessDenied(<span class="type">ServletRequest</span> request, <span class="type">ServletResponse</span> response) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> req = com.uniweibov2.shiro.<span class="type">WebUtils</span>.toHttp(request);</span><br><span class="line">        <span class="type">HttpServletResponse</span> res = com.uniweibov2.shiro.<span class="type">WebUtils</span>.toHttp(response);</span><br><span class="line">        <span class="type">String</span> path = <span class="type">WebUtils</span>.getRequestUri(req);</span><br><span class="line">      <span class="comment">//my开头的请求用于页面跳转</span></span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">"/my"</span>)) &#123;</span><br><span class="line">            res.sendError(<span class="number">401</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//其余是ajax异步请求</span></span><br><span class="line">            <span class="type">PrintWriter</span> out = response.getWriter();</span><br><span class="line">            out.println(<span class="string">"&#123;\"error_info\":\"permission denied.\"&#125;"</span>);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public boolean isAccessAllowed(<span class="type">ServletRequest</span> request, <span class="type">ServletResponse</span> response, <span class="type">Object</span> mappedValue) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Subject</span> subject = getSubject(request, response);</span><br><span class="line">        <span class="type">HttpServletRequest</span> req = (<span class="type">HttpServletRequest</span>) request;</span><br><span class="line">        <span class="comment">//mappedValue的值就是上面spring-shiro.xml 过滤器链定义中roles["user,admin"] 括号里面的值</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span>[] rolesArray = (<span class="type">String</span>[]) mappedValue;</span><br><span class="line">        <span class="keyword">if</span> (rolesArray == <span class="literal">null</span> || rolesArray.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">String</span> roleName : rolesArray) &#123;</span><br><span class="line">            <span class="keyword">if</span> (subject.hasRole(roleName)) &#123;  <span class="comment">//判断当前用户是否拥有这个角色</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>MyRoleFilter重写isAccessAllowed和onAccessDenied方法</p>
<p>isAccessAllowed方法用于角色权限检测，因为父类的isAccessAllowed方法中的检测逻辑是必须符合所有mappedValue中的角色，而我们的需求是只有用户属于其中任意一个角色就可以通过了，因此需要自定义实现</p>
<p>onAccessDenied方法实现的是当权限不通过时，应该如何处理</p>
<h2 id="URL权限校验">URL权限校验</h2><p>自定义PermissionsAuthorizationFilter<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyURLPermissionFilter</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">PermissionsAuthorizationFilter</span>&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> log = <span class="type">LoggerFactory</span>.getLogger(<span class="type">MyURLPermissionFilter</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> boolean onAccessDenied(<span class="type">ServletRequest</span> request, <span class="type">ServletResponse</span> response) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> req = <span class="type">WebUtils</span>.toHttp(request);</span><br><span class="line">        <span class="type">HttpServletResponse</span> res = <span class="type">WebUtils</span>.toHttp(response);</span><br><span class="line">        <span class="type">String</span> path = <span class="type">WebUtils</span>.getRequestUri(req);</span><br><span class="line">        <span class="keyword">if</span>(path.startsWith(<span class="string">"/my/"</span>)) &#123;</span><br><span class="line">            res.sendError(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PrintWriter</span> out = response.getWriter();</span><br><span class="line">            out.println(<span class="string">"&#123;\"error_info\":\"permission denied.\"&#125;"</span>);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public boolean isAccessAllowed(<span class="type">ServletRequest</span> request, <span class="type">ServletResponse</span> response, <span class="type">Object</span> mappedValue) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">        <span class="type">Subject</span> subject = <span class="keyword">this</span>.getSubject(request, response);</span><br><span class="line">        <span class="type">HttpServletRequest</span> req = <span class="type">WebUtils</span>.toHttp(request);</span><br><span class="line">        <span class="type">String</span> path = <span class="type">WebUtils</span>.getRequestUri(req);</span><br><span class="line">        <span class="type">String</span> method = req.getMethod();</span><br><span class="line">        <span class="type">String</span> permission = path + <span class="string">":"</span> + method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!subject.isPermitted(permission)) &#123; <span class="comment">//与上文MyRealm的getAuthorizationInfo方法返回的AuthorizationInfo中的权限集合匹配</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>到目前为止，已经完成shiro与spring整合，并且实现了角色和URL的权限管理了。</p>
<h1 id="常见问题">常见问题</h1><h2 id="关于shiro_session">关于shiro session</h2><p>Shiro 中的 Session 不依赖 HTTP 环境。如果将 Shiro 部署在 web 应用程序中，那么这个 Session 就是基于HttpSession 的。在非 web 环境下使用，Shiro 则默认使用 EnterpriseSessionManagment</p>
<p>【完】</p>
<p>参考：</p>
<p><a href="http://blog.aquariuslt.com/2015/10/25/apache-shiro-spring-integration" target="_blank" rel="external">Spring 整合 Apache Shiro 实现各等级的权限管理</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://zclau.com/2016/02/16/Shiro与Spring集成实现权限管理/" data-id="cipieex6a000queta4hcpr4au" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Shiro/">Shiro</a></div><div class="post-nav"><a href="/2016/02/02/linux核心命令/" class="next">linux核心命令</a><a href="/2016/03/22/Java-SimpleDateFormat的线程安全性问题/" class="prev">Java SimpleDateFormat的线程安全性问题</a></div><div data-thread-key="2016/02/16/Shiro与Spring集成实现权限管理/" data-title="Shiro与Spring集成实现权限管理" data-url="http://zclau.com/2016/02/16/Shiro与Spring集成实现权限管理/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/02/16/Shiro与Spring集成实现权限管理/" data-title="Shiro与Spring集成实现权限管理" data-url="http://zclau.com/2016/02/16/Shiro与Spring集成实现权限管理/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://zclau.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webdev/">Web开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码优化/">代码优化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/SimpleDateFormat/" style="font-size: 15px;">SimpleDateFormat</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/Linux命令/" style="font-size: 15px;">Linux命令</a> <a href="/tags/Shiro/" style="font-size: 15px;">Shiro</a> <a href="/tags/core-Java/" style="font-size: 15px;">core Java</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/Java注解/">Java注解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/Java-SimpleDateFormat的线程安全性问题/">Java SimpleDateFormat的线程安全性问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/16/Shiro与Spring集成实现权限管理/">Shiro与Spring集成实现权限管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/02/linux核心命令/">linux核心命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/05/一次使用新浪微博api抓取数据的优化/">一次使用新浪微博api抓取数据的优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/hexo部署在vps上/">hexo部署在vps上</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/使用hexo搭建个人博客/">使用hexo搭建个人博客</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Coding.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script>var duoshuoQuery = {short_name:'zclau'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>